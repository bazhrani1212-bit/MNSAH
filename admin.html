<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±Ø© â€” Ù†ØªØ§Ø¦Ø¬ Ù‚ÙŠØ§Ø³ Ø§Ù„Ø£Ø«Ø±</title>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial; margin:0; background:#f6f7fb;}
    header{background:#334155; color:#fff; padding:14px 12px;}
    .wrap{max-width:1200px; margin:0 auto; padding:14px;}
    .brand{display:flex; flex-direction:column; gap:6px;}
    .brand h1{margin:0; font-size:18px; font-weight:900;}
    .brand .sub{opacity:.95; font-size:13px; line-height:1.5;}
    .card{background:#fff; border-radius:14px; padding:14px; box-shadow:0 1px 8px rgba(0,0,0,.06); margin:10px 0;}
    .btn{border:0; background:#0f766e; color:#fff; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:900}
    .btn.gray{background:#475569}
    .btn.light{background:#64748b}
    input,select{padding:10px; border-radius:10px; border:1px solid #d0d7de; width:100%}
    .row{display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:10px}
    @media(max-width:1100px){.row{grid-template-columns:1fr 1fr}}
    @media(max-width:700px){.row{grid-template-columns:1fr}}
    table{width:100%; border-collapse:collapse; font-size:13px}
    th,td{border-bottom:1px solid #eef2f7; padding:10px; text-align:right; vertical-align:top}
    th{background:#f1f5f9}
    .hint{color:#64748b; font-size:12px}
    .ok{background:#ecfdf5; border:1px solid #10b981; color:#065f46; padding:10px; border-radius:12px; display:none}
    .err{background:#fef2f2; border:1px solid #ef4444; color:#7f1d1d; padding:10px; border-radius:12px; display:none}
    footer{padding:18px 12px; color:#64748b; font-size:12px; text-align:center}
    .actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .tag{display:inline-block; padding:4px 10px; border-radius:999px; background:#e2e8f0; font-size:12px; margin:2px 4px 2px 0;}
    .mini{font-size:12px; color:#64748b}
    .linklike{color:#0f766e; font-weight:900; cursor:pointer; text-decoration:underline}

    /* Stats */
    .stats{display:grid; grid-template-columns:repeat(4,1fr); gap:10px;}
    @media(max-width:1100px){.stats{grid-template-columns:repeat(2,1fr);}}
    @media(max-width:700px){.stats{grid-template-columns:1fr;}}
    .stat{border:1px solid #eef2f7; border-radius:14px; padding:12px;}
    .stat .k{color:#64748b; font-size:12px; margin-bottom:6px;}
    .stat .v{font-weight:1000; font-size:18px;}
    .barRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .bar{background:#f1f5f9; border:1px solid #e2e8f0; border-radius:999px; padding:6px 10px; font-size:12px;}
    .bar b{font-weight:1000;}

    /* Modal */
    .backdrop{position:fixed; inset:0; background:rgba(15,23,42,.55); display:none; align-items:center; justify-content:center; padding:14px; z-index:9999;}
    .modal{max-width:900px; width:100%; background:#fff; border-radius:16px; box-shadow:0 12px 40px rgba(0,0,0,.25); overflow:hidden;}
    .modalHead{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; background:#f1f5f9; border-bottom:1px solid #e2e8f0;}
    .modalHead .title{font-weight:1000}
    .closeX{border:0; background:transparent; font-size:20px; cursor:pointer; padding:4px 8px; line-height:1;}
    .modalBody{padding:14px; max-height:72vh; overflow:auto;}
    .sectionTitle{font-weight:1000; margin:12px 0 8px;}
    .field{background:#fff; border:1px solid #eef2f7; border-radius:12px; padding:10px; margin:8px 0;}
    .field .k{font-size:12px; color:#64748b; margin-bottom:6px;}
    .field .v{font-size:14px; white-space:pre-wrap; word-break:break-word;}
    .pill{display:inline-block; padding:4px 10px; border-radius:999px; background:#e6fffb; border:1px solid #99f6e4; margin:2px 4px 2px 0; font-size:12px;}
    .qItem{border:1px solid #eef2f7; border-radius:12px; padding:10px; margin:8px 0;}
    .qItem .q{font-weight:900; margin-bottom:6px;}
    .qItem .a{color:#0f172a;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; font-size:12px;}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±Ø© â€” Ù…Ù†ØµØ© Ù‚ÙŠØ§Ø³ Ø§Ù„Ø£Ø«Ø± ÙˆØ±Ø¶Ø§ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯</h1>
      <div class="sub">
        Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: <b>Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ© Ø§Ù„Ø³Ø§Ø¯Ø³Ø© ÙˆØ§Ù„Ø«Ù„Ø§Ø«ÙˆÙ† Ø¨Ø§Ù„Ø®Ù…ÙŠØ³</b> â€” Ù…Ø¯ÙŠØ±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: <b>Ù†ÙˆØ±Ø© Ø§Ù„Ø±ÙØ§Ø¹ÙŠ</b><br>
        Ø¹Ø±Ø¶ Ù…Ø¨Ø§Ø´Ø± Ù…Ù† Google Sheet (ÙŠØªØ·Ù„Ø¨ Admin Token).
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="ok" id="okBox"></div>
  <div class="err" id="errBox"></div>

  <div class="card">
    <div class="actions">
      <a class="btn gray" href="index.html">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù†Ù…Ø§Ø°Ø¬</a>
      <button class="btn" id="loadBtn">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
      <button class="btn gray" id="exportCsvBtn">ØªØµØ¯ÙŠØ± CSV</button>
    </div>
    <div class="hint" style="margin-top:10px" id="statusLine">â³ ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„â€¦</div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <label class="hint">Admin Token</label>
        <input id="tokenInput" placeholder="Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ ÙˆØ±Ù‚Ø© settings" />
      </div>
      <div>
        <label class="hint">Ø§Ù„Ù†ÙˆØ¹</label>
        <select id="typeFilter">
          <option value="">Ø§Ù„ÙƒÙ„</option>
          <option value="impact">Ù‚ÙŠØ§Ø³ Ø§Ù„Ø£Ø«Ø±</option>
          <option value="teacher_satisfaction">Ø±Ø¶Ø§ Ø§Ù„Ù…Ø¹Ù„Ù…</option>
          <option value="student_school_satisfaction">Ø±Ø¶Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¹Ù† Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</option>
          <option value="parent_satisfaction">Ø±Ø¶Ø§ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</option>
          <option value="student_teacher_satisfaction">Ø±Ø¶Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¹Ù† Ø§Ù„Ù…Ø¹Ù„Ù…</option>
        </select>
      </div>
      <div>
        <label class="hint">Ø¨Ø­Ø« Ù†ØµÙŠ</label>
        <input id="searchText" placeholder="Ø¹Ù„ÙˆÙ… / Ø¨Ø±Ù†Ø§Ù…Ø¬ / Ø£Ø«Ø± ..." />
      </div>
      <div>
        <label class="hint">Ø§Ù„Ø­Ø¯</label>
        <select id="limitSel">
          <option value="200">200</option>
          <option value="500" selected>500</option>
          <option value="1000">1000</option>
          <option value="2000">2000</option>
        </select>
      </div>
    </div>
    <div class="hint" style="margin-top:10px;">ğŸ’¡ Ø§Ø¶ØºØ·ÙŠ â€œØ¹Ø±Ø¶â€ Ù„ÙØªØ­ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© ÙƒØ§Ø³ØªÙ…Ø§Ø±Ø© ÙÙŠ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø©.</div>
  </div>

  <!-- Stats -->
  <div class="card">
    <div class="sectionTitle">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©</div>
    <div class="stats">
      <div class="stat"><div class="k">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø§Øª</div><div class="v" id="st_total">â€”</div></div>
      <div class="stat"><div class="k">Ø¹Ø¯Ø¯ â€œÙ‚ÙŠØ§Ø³ Ø§Ù„Ø£Ø«Ø±â€</div><div class="v" id="st_impact">â€”</div></div>
      <div class="stat"><div class="k">Ù…ØªÙˆØ³Ø· % Ø§Ù„Ø£Ø«Ø± (Impact)</div><div class="v" id="st_avgImpactPct">â€”</div></div>
      <div class="stat"><div class="k">Ù…ØªÙˆØ³Ø· ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù (Impact)</div><div class="v" id="st_avgGoalPct">â€”</div></div>
    </div>
    <div class="barRow" id="st_countsByType"></div>
    <div class="barRow" id="st_likertDist"></div>
    <div class="hint" style="margin-top:10px;">* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ (ÙˆÙ‚Ø¯ ØªØªØºÙŠØ± Ø­Ø³Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ±).</div>
  </div>

  <!-- Table -->
  <div class="card">
    <div class="hint" id="summaryLine">â€”</div>
    <div style="overflow:auto; margin-top:10px">
      <table>
        <thead>
          <tr>
            <th>Ø§Ù„Ù†ÙˆØ¹</th>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</th>
            <th>Ù…Ø®ØªØµØ±</th>
            <th>Ø¹Ø±Ø¶</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>
</div>

<footer>ØªØµÙ…ÙŠÙ…/Ø¥Ø¹Ø¯Ø§Ø¯: Ø¨Ø¯Ø±ÙŠØ© Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</footer>

<!-- Modal -->
<div class="backdrop" id="backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modalHead">
      <div class="title" id="modalTitle">Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©</div>
      <button class="closeX" id="closeX" title="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
  </div>
</div>

<script>
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyZBgj7Qomh3858lXJWripmkFlKW_bcUD8POm7XXCuk6nAQJAc6EPZdFu8YOciaMdUM/exec";

const okBox = document.getElementById('okBox');
const errBox = document.getElementById('errBox');
const statusLine = document.getElementById('statusLine');
const rowsEl = document.getElementById("rows");
const summaryLine = document.getElementById("summaryLine");

const tokenInput = document.getElementById("tokenInput");
const typeFilter = document.getElementById("typeFilter");
const searchText = document.getElementById("searchText");
const limitSel = document.getElementById("limitSel");

let allData = [];

function showOk(msg){ okBox.textContent=msg; okBox.style.display='block'; errBox.style.display='none'; setTimeout(()=>okBox.style.display='none', 3500); }
function showErr(msg){ errBox.textContent=msg; errBox.style.display='block'; okBox.style.display='none'; setTimeout(()=>errBox.style.display='none', 6500); }
function esc(s){ return (s??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

function fmtType(t){
  const map={
    impact:"Ù‚ÙŠØ§Ø³ Ø§Ù„Ø£Ø«Ø±",
    teacher_satisfaction:"Ø±Ø¶Ø§ Ø§Ù„Ù…Ø¹Ù„Ù…",
    student_school_satisfaction:"Ø±Ø¶Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¹Ù† Ø§Ù„Ù…Ø¯Ø±Ø³Ø©",
    parent_satisfaction:"Ø±Ø¶Ø§ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±",
    student_teacher_satisfaction:"Ø±Ø¶Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¹Ù† Ø§Ù„Ù…Ø¹Ù„Ù…"
  };
  return map[t]||t;
}

function safeJsonParse(v){
  if(v == null) return null;
  if(typeof v === "object") return v;
  const s = String(v).trim();
  if(!s) return null;
  try{ return JSON.parse(s); }catch{ return null; }
}

function rowBrief(x){
  if(x.type==="impact"){
    const tags=[
      x.program?`Ø¨Ø±Ù†Ø§Ù…Ø¬: ${x.program}`:null,
      x.impactLevel?`Ø§Ù„Ø£Ø«Ø±: ${x.impactLevel}`:null,
      (x.effectPct!=="" && x.effectPct!=null)?`%Ø§Ù„Ø£Ø«Ø±: ${x.effectPct}`:null
    ].filter(Boolean);
    return tags.map(t=>`<span class="tag">${esc(t)}</span>`).join('');
  }
  const ans = safeJsonParse(x.answers);
  const answered = ans ? Object.values(ans).filter(Boolean).length : 0;
  const tags=[`Ø¨Ù†ÙˆØ¯ Ù…Ø¬Ø§Ø¨Ø©: ${answered}`, x.subject?`Ù…Ø§Ø¯Ø©: ${x.subject}`:null, x.grade?`ØµÙ: ${x.grade}`:null].filter(Boolean);
  return tags.map(t=>`<span class="tag">${esc(t)}</span>`).join('');
}

/** ===== Questions text (Ø­ØªÙ‰ ÙŠØ¸Ù‡Ø± ÙƒØ§Ø³ØªÙ…Ø§Ø±Ø©) ===== */
const QUESTIONS = {
  teacher_satisfaction: [
    "Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ÙˆÙŠØ¹Ø§Ù…Ù„Ù‡Ù… ÙƒØ£Ø®ÙˆØ©.","ÙŠØ¹Ø¯Ù„ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙÙŠ ØªØ¹Ø§Ù…Ù„Ù‡ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†.","ÙŠÙ‚ÙˆÙ… Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¨ØªÙƒØ±ÙŠÙ… Ø§Ù„Ù…ØªÙ…ÙŠØ²ÙŠÙ† Ù…Ù† Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†.",
    "ÙŠÙ‚Ø¯Ø± Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¸Ø±ÙˆÙ Ø§Ù„Ù…Ø¹Ù„Ù… Ø¥Ø°Ø§ Ø£Ø®Ø¨Ø±Ù‡ Ø¨Ù‡Ø§.","ÙŠØªÙŠØ­ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù„Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ÙØ±ØµØ§ Ù„ØªØ·ÙˆÙŠØ± Ù…Ø³ØªÙˆØ§Ù‡Ù….","ÙŠØ´Ø¬Ø¹ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ÙŠÙ† Ù„Ù„ØªÙ‚Ø¯Ù… Ù„Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ.",
    "ÙŠØ³ØªØ´ÙŠØ± Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ù‚Ø¨Ù„ Ø§ØªØ®Ø§Ø° Ù‚Ø±Ø§Ø±Ø§ØªÙ‡.","ÙŠÙ‚ÙˆÙ… Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¨Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø²ÙŠØ§Ø±Ø© ØµÙÙŠØ©.","ÙŠÙ‚ÙˆÙ… Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ØªÙ‚ÙˆÙŠÙ…Ø§ Ø´Ø§Ù…Ù„Ø§.",
    "ÙŠÙˆØ²Ø¹ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø£Ù†ØµØ¨Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¹Ø§Ø¯Ù„Ø©.","ÙŠÙ‚Ø¯Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙ‡ ÙˆØªÙˆØ¬ÙŠÙ‡Ø§ØªÙ‡ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ù†Ø§Ø³Ø¨Ø©.","ÙŠÙ…Ø«Ù„ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù‚Ø¯ÙˆØ© ÙÙŠ Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø· ÙÙŠ Ø§Ù„Ø¹Ù…Ù„.",
    "ÙŠØ³ØªØ®Ø¯Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ø«ÙˆØ§Ø¨ ÙˆØ§Ù„Ø¹Ù‚Ø§Ø¨.","ÙŠØ·Ù„Ø¹ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª ÙˆØ§Ù„Ù†Ø¸Ù… Ø¨Ø´ÙƒÙ„ Ù…Ø³ØªÙ…Ø±.","Ø£Ø¬Ø¯ Ø±ØºØ¨Ø© ÙÙŠ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙÙŠ Ø§Ù„Ø£Ø²Ù…Ø§Øª.",
    "Ù„Ø§ Ø£Ø¬Ø¯ Ø­Ø±Ø¬Ø§ ÙÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ù„Ø§ØµÙÙŠØ© Ø®Ø§Ø±Ø¬ ÙˆÙ‚Øª Ø§Ù„Ø¯ÙˆØ§Ù….","Ø£Ø±ØºØ¨ Ø¨Ø²ÙŠØ§Ø±Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù„ÙŠ Ø²ÙŠØ§Ø±Ø© ØµÙÙŠØ©.","Ø£Ø±ØºØ¨ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¥Ù„Ù‰ Ù…Ø¯Ø±Ø³Ø© Ø£Ø®Ø±Ù‰."
  ],
  student_school_satisfaction: [
    "ØªØ¹ØªÙ†ÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¨Ø±ÙØ¹ Ù…Ø³ØªÙˆÙ‰ ØªØ­ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨.","ØªØªÙŠØ­ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù„Ù„Ø·Ù„Ø§Ø¨ ÙØ±Øµ Ø§ÙƒØªØ´Ø§Ù Ù…ÙˆØ§Ù‡Ø¨Ù‡Ù… ÙˆÙ‚Ø¯Ø±Ø§ØªÙ‡Ù….","ØªÙ‡ØªÙ… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¨Ù†Ø¸Ø§ÙØ© Ø§Ù„ÙØµÙˆÙ„ ÙˆÙ†Ø¸Ø§ÙØ© Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù….",
    "ØªØ£Ø®Ø° Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¨Ø¢Ø±Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠÙ…Ø§ ÙŠØªØ¹Ù„Ù‚ Ø¨Ø§Ø­ØªÙŠØ§Ø¬Ø§ØªÙ‡Ù….","ØªÙ‡ØªÙ… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¨Ù†ÙˆØ¹ÙŠØ© Ø§Ù„ÙˆØ¬Ø¨Ø§Øª Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ù…Ù‚ØµÙ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ.","ØªÙƒØ±Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø·Ù„Ø¨Ø© Ø§Ù„Ù…ØªÙ…ÙŠØ²ÙŠÙ† ÙˆØ§Ù„Ù…ØªÙÙˆÙ‚ÙŠÙ†.",
    "ØªÙ‚ÙŠÙ… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù…Ù†Ø§Ø´Ø· Ø§Ù„Ù„Ø§ØµÙÙŠØ© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ ÙˆØ®Ø§Ø±Ø¬Ù‡.","ØªØ¹ØªÙ†ÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¨Ø­Ù„ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªÙŠ ØªØ¹ØªØ±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨.","ØªØ´Ø±Ùƒ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ.",
    "ÙŠØ³ØªÙÙŠØ¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Ù‚Ø§Ø¹Ø© Ù…ØµØ§Ø¯Ø± Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©.","Ø£Ø´Ø¹Ø± Ø¨ØªÙ…Ø§Ù… Ø§Ù„Ø±Ø§Ø­Ø© ÙÙŠ Ù…Ø¯Ø±Ø³ØªÙŠ.","Ø£ØªÙ…Ù†Ù‰ Ø£Ù† Ø£Ù†ØªÙ‚Ù„ Ø¥Ù„Ù‰ Ù…Ø¯Ø±Ø³Ø© Ø£Ø®Ø±Ù‰."
  ],
  parent_satisfaction: [
    "ØªØªÙˆØ§ØµÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù…Ø¹ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ± Ù„Ù…Ø´Ø§Ø±ÙƒØªÙ‡Ù… ÙÙŠ Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙˆØ±Ø³Ø§Ù„ØªÙ‡Ø§.","Ø£Ø´Ø¹Ø± Ø¨Ø§Ø­ØªØ±Ø§Ù… ÙˆØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¹Ù†Ø¯ ØªØ¹Ø§Ù…Ù„Ù‡Ø§ Ù…Ø¹ÙŠ (ÙƒÙˆÙ„ÙŠ Ø£Ù…Ø± Ø·Ø§Ù„Ø¨).",
    "Ø£Ù„Ø§Ø­Ø¸ Ø£Ù† Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ØªØ´Ø¬Ø¹ Ø·Ù„Ø§Ø¨Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ…ÙŠØ² ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª.","ØªØªØ§Ø­ Ù„ÙŠ ÙØ±ØµØ© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ù…Ø¹ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©.",
    "ØªØ­Ø±Øµ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¹Ù„Ù‰ Ù…Ø´Ø§Ø±ÙƒØ© Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ± ÙÙŠ Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„ØµØ­ÙŠØ© Ù„Ù„Ù…ØªØ¹Ù„Ù…ÙŠÙ†.","ØªØ­Ø±Øµ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¹Ù„Ù‰ ØªÙŠØ³ÙŠØ± Ø§Ù„ØªÙˆØ§ØµÙ„ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ÙˆØ§Ù„Ù…ØªØ¹Ù„Ù…ÙŠÙ† ÙˆØ£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ± Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.",
    "ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù†Ø¸Ø§Ù…Ø§Ù‹ Ù„Ø¥Ø¹Ù„Ø§Ù… Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ± Ø¨Ù…Ø³ØªÙˆÙ‰ ØªÙ‚Ø¯Ù… Ø£Ø¯Ø§Ø¡ Ø£Ø¨Ù†Ø§Ø¦Ù‡Ù….","ØªØ­Ø±Øµ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¹Ù„Ù‰ Ù…Ø´Ø§Ø±ÙƒØ© Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ± ÙÙŠ ØªØ·ÙˆÙŠØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©.",
    "ØªÙ†Ø´Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø«Ù‚Ø§ÙØ© Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ Ø§Ù„ØªØ±Ø¨ÙˆÙŠ ÙˆØ§Ù„Ù†ÙØ³ÙŠ Ø¨ÙŠÙ† Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±.","ØªÙˆÙØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù„Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø£Ù…ÙˆØ± Ø§Ù„Ø·Ù„Ø§Ø¨ Ø£Ø±Ù‚Ø§Ù…Ø§ Ù„Ù„ØªÙˆØ§ØµÙ„ (Ø«Ø§Ø¨Øª â€“ Ø¬ÙˆØ§Ù„)."
  ],
  student_teacher_satisfaction: [
    "ÙŠØ­Ø±Øµ Ø§Ù„Ù…Ø¹Ù„Ù… Ø¹Ù„Ù‰ ØªÙˆØ¶ÙŠØ­ Ø§Ù„Ø¯Ø±Ø³ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ù†Ø§Ø³Ø¨Ø©.","ÙŠÙ‡ØªÙ… Ø§Ù„Ù…Ø¹Ù„Ù… Ø¨ØªÙˆØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨.","ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø·Ø±Ù‚Ø§ Ø­Ø¯ÙŠØ«Ø© ÙˆÙ…ØªÙ†ÙˆØ¹Ø© ÙÙŠ Ø´Ø±Ø­ Ø§Ù„Ø¯Ø±ÙˆØ³.",
    "ÙŠÙ†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ù„Ù… ÙÙŠ Ø·Ø±Ù‚ ØªØ¯Ø±ÙŠØ³Ù‡.","ÙŠØ¹ØªÙ†ÙŠ Ø§Ù„Ù…Ø¹Ù„Ù… Ø¨Ø§Ù„ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø¹Ù†Ø¯ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø©.","ÙŠØ´Ø¬Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø·Ù„Ø§Ø¨.",
    "ÙŠØ¨Ø°Ù„ Ø§Ù„Ù…Ø¹Ù„Ù… Ø¬Ù‡Ø¯Ù‡ Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ù„Ù„ ÙˆØ§Ù„Ø³Ø¢Ù…Ø© Ø¹Ù† Ø§Ù„Ø·Ù„Ø§Ø¨.","ÙŠØ£Ø®Ø° Ø§Ù„Ù…Ø¹Ù„Ù… Ø¨Ø¢Ø±Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨.","ÙŠÙ‚ÙŠÙ… Ø§Ù„Ù…Ø¹Ù„Ù… Ù…Ø¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¹Ù„Ø§Ù‚Ø© ØµØ¯Ø§Ù‚Ø©.","ÙŠÙ‡ØªÙ… Ø§Ù„Ù…Ø¹Ù„Ù… Ø¨Ø­Ù„ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨."
  ]
};

async function ping(){
  const r = await fetch(`${APPS_SCRIPT_URL}?action=ping`);
  const j = await r.json();
  return !!j?.ok;
}

async function loadFromSheet(){
  const token = (tokenInput.value || "").trim();
  if(!token){ showErr("Ø¶Ø¹ÙŠ Admin Token Ø£ÙˆÙ„Ù‹Ø§."); return; }

  const type = (typeFilter.value || "").trim();
  const q = (searchText.value || "").trim();
  const limit = Number(limitSel.value||500);

  const u = new URL(APPS_SCRIPT_URL);
  u.searchParams.set("action","list");
  u.searchParams.set("token", token);
  u.searchParams.set("limit", String(limit));
  if(type) u.searchParams.set("type", type);
  if(q) u.searchParams.set("q", q);

  try{
    const res = await fetch(u.toString());
    const json = await res.json();
    if(!json.ok){
      if(json.error === "UNAUTHORIZED") { showErr("ØªÙˆÙƒÙ† ØºÙŠØ± ØµØ­ÙŠØ­ (settings â†’ ADMIN_TOKEN)."); return; }
      throw new Error(json.error || "LOAD_FAILED");
    }
    allData = json.data || [];
    renderTable();
    computeStats();
    showOk("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ âœ…");
  }catch(e){
    console.error(e);
    showErr("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬. ØªØ­Ù‚Ù‚ÙŠ Ù…Ù† Ø§Ù„Ù†Ø´Ø± Web App (Anyone) ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.");
  }
}

function renderTable(){
  summaryLine.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: ${allData.length}`;
  rowsEl.innerHTML = allData.map((x,idx)=>`
    <tr>
      <td>${esc(fmtType(x.type))}</td>
      <td class="mini">${esc(x.createdAt||"")}</td>
      <td>${esc(x.school||"â€”")}</td>
      <td>${rowBrief(x)}</td>
      <td><span class="linklike" data-i="${idx}">Ø¹Ø±Ø¶</span></td>
    </tr>
  `).join('');
  rowsEl.querySelectorAll('[data-i]').forEach(el=>{
    el.addEventListener('click', ()=>{
      const i = Number(el.getAttribute('data-i'));
      openModal(allData[i]);
    });
  });
}

function computeStats(){
  const total = allData.length;
  document.getElementById("st_total").textContent = total;

  const byType = {};
  let impactCount = 0, sumImpactPct = 0, sumGoalPct = 0, cntImpactPct = 0, cntGoalPct = 0;

  // Likert distribution across all satisfaction forms
  const likertDist = { "Ø¯Ø§Ø¦Ù…Ø§Ù‹":0, "ØºØ§Ù„Ø¨Ø§Ù‹":0, "Ø£Ø­ÙŠØ§Ù†Ø§Ù‹":0, "Ù†Ø§Ø¯Ø±Ø§Ù‹":0 };

  allData.forEach(x=>{
    const t = x.type || "unknown";
    byType[t] = (byType[t]||0) + 1;

    if(t === "impact"){
      impactCount++;
      const ep = Number(x.effectPct);
      const gp = Number(x.goalPct);
      if(!Number.isNaN(ep) && ep > 0){ sumImpactPct += ep; cntImpactPct++; }
      if(!Number.isNaN(gp) && gp > 0){ sumGoalPct += gp; cntGoalPct++; }
    }

    const ans = safeJsonParse(x.answers);
    if(ans && typeof ans === "object"){
      Object.values(ans).forEach(v=>{
        if(likertDist[v] != null) likertDist[v] += 1;
      });
    }
  });

  document.getElementById("st_impact").textContent = impactCount;
  document.getElementById("st_avgImpactPct").textContent = cntImpactPct ? Math.round(sumImpactPct/cntImpactPct) + "%" : "â€”";
  document.getElementById("st_avgGoalPct").textContent = cntGoalPct ? Math.round(sumGoalPct/cntGoalPct) + "%" : "â€”";

  // counts by type chips
  const box = document.getElementById("st_countsByType");
  box.innerHTML = Object.entries(byType).map(([k,v])=>`<span class="bar"><b>${esc(fmtType(k))}</b>: ${v}</span>`).join("");

  // likert chips
  const lbox = document.getElementById("st_likertDist");
  const totalLikert = Object.values(likertDist).reduce((a,b)=>a+b,0);
  lbox.innerHTML = totalLikert
    ? Object.entries(likertDist).map(([k,v])=>{
        const pct = Math.round((v/totalLikert)*100);
        return `<span class="bar"><b>${esc(k)}</b>: ${v} (${pct}%)</span>`;
      }).join("")
    : `<span class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø³ØªØ¨Ø§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ø¹Ø±Ø¶ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª.</span>`;
}

function exportCsv(){
  if(!allData.length){ showErr("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§."); return; }
  const cols = Object.keys(allData[0]);
  const lines = [cols.join(",")];
  allData.forEach(x=>{
    const row = cols.map(c => `"${String(x[c]??"").replaceAll('"','""')}"`);
    lines.push(row.join(","));
  });
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "admin_view.csv"; a.click();
  URL.revokeObjectURL(url);
}

/** ===== Modal ===== */
const backdrop = document.getElementById("backdrop");
const modalBody = document.getElementById("modalBody");
const modalTitle = document.getElementById("modalTitle");
const closeX = document.getElementById("closeX");

function openModal(x){
  modalTitle.textContent = `Ø§Ø³ØªØ¬Ø§Ø¨Ø© â€” ${fmtType(x.type)} â€” ${x.createdAt || ""}`;

  const tools = safeJsonParse(x.tools) || (typeof x.tools === "string" ? safeJsonParse(x.tools) : null);
  const evidence = safeJsonParse(x.evidenceLinks) || (typeof x.evidenceLinks === "string" ? safeJsonParse(x.evidenceLinks) : null);
  const answers = safeJsonParse(x.answers);
  const meta = safeJsonParse(x.meta);

  // Header fields
  const headerFields = [
    ["ID", x.id],
    ["Ø§Ù„ØªØ§Ø±ÙŠØ®", x.createdAt],
    ["Ø§Ù„Ù…Ø¯Ø±Ø³Ø©", x.school],
    ["Ø§Ù„Ù†ÙˆØ¹", fmtType(x.type)]
  ];

  // Type-specific fields
  const extraFields = [];
  if(x.type === "impact"){
    extraFields.push(["Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬", x.program]);
    extraFields.push(["Ø§Ù„Ù…Ø¬Ø§Ù„", x.domain]);
    extraFields.push(["Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙÙˆÙ†", x.targets]);
    extraFields.push(["Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…", x.performance]);
    extraFields.push(["Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø«Ø±", x.impactLevel]);
    extraFields.push(["Ù†Ø³Ø¨Ø© ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù", x.goalPct]);
    extraFields.push(["Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© Ù„Ù„Ø£Ø«Ø±", x.effectPct]);
    extraFields.push(["Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„ØªÙ†ÙÙŠØ°", x.method]);
    extraFields.push(["ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ†ÙÙŠØ°", x.date]);
    extraFields.push(["Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹", x.week]);
    extraFields.push(["Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨/Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª", x.nStudents]);
    extraFields.push(["Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†/Ø§Ù„Ù…Ø¹Ù„Ù…Ø§Øª", x.nTeachers]);
    extraFields.push(["Ø¹Ø¯Ø¯ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±", x.nParents]);
    extraFields.push(["Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù„Ø¬Ù†Ø©", x.committee]);
    extraFields.push(["Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ§Øª", x.positives]);
    extraFields.push(["Ø§Ù„ØµØ¹ÙˆØ¨Ø§Øª", x.challenges]);
  } else if(x.type === "teacher_satisfaction"){
    extraFields.push(["Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)", x.name]);
    extraFields.push(["Ù…Ù„Ø§Ø­Ø¸Ø§Øª", x.notes]);
  } else if(x.type === "student_school_satisfaction"){
    extraFields.push(["Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)", x.name]);
    extraFields.push(["Ø§Ù„ØµÙ", x.grade]);
    extraFields.push(["Ù…Ù„Ø§Ø­Ø¸Ø§Øª", x.notes]);
  } else if(x.type === "parent_satisfaction"){
    extraFields.push(["Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)", x.parentName]);
    extraFields.push(["Ø§Ù„Ù…Ø¤Ù‡Ù„", x.education]);
    extraFields.push(["Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨/Ø§Ù„Ø·Ø§Ù„Ø¨Ø©", x.studentName]);
    extraFields.push(["Ù…Ù„Ø§Ø­Ø¸Ø§Øª", x.notes]);
  } else if(x.type === "student_teacher_satisfaction"){
    extraFields.push(["Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)", x.name]);
    extraFields.push(["Ø§Ù„ØµÙ", x.grade]);
    extraFields.push(["Ø§Ù„Ù…Ø§Ø¯Ø©", x.subject]);
    extraFields.push(["Ù…Ù„Ø§Ø­Ø¸Ø§Øª", x.notes]);
  }

  const toolsHtml = Array.isArray(tools) && tools.length
    ? tools.map(t=>`<span class="pill">${esc(t)}</span>`).join('')
    : `<span class="mini">â€”</span>`;

  const evidenceHtml = Array.isArray(evidence) && evidence.length
    ? evidence.map(u=>`<div class="mono">â€¢ ${esc(u)}</div>`).join('')
    : `<span class="mini">â€”</span>`;

  // Form-like answers with question text
  let formAnswersHtml = `<div class="hint">â€”</div>`;
  const qList = QUESTIONS[x.type];
  if(answers && typeof answers === "object" && Array.isArray(qList) && qList.length){
    formAnswersHtml = qList.map((qText, idx)=>{
      const key = String(idx+1);
      const a = answers[key] ?? answers[idx+1] ?? answers[key.trim()] ?? null;
      return `
        <div class="qItem">
          <div class="q">${idx+1}) ${esc(qText)}</div>
          <div class="a"><b>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:</b> ${esc(a || "â€”")}</div>
        </div>
      `;
    }).join("");
  } else if(answers && typeof answers === "object"){
    // fallback: show raw keys
    formAnswersHtml = Object.entries(answers).map(([k,v])=>`
      <div class="qItem">
        <div class="q">Ø§Ù„Ø¨Ù†Ø¯ ${esc(k)}</div>
        <div class="a"><b>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:</b> ${esc(v || "â€”")}</div>
      </div>
    `).join("");
  }

  const metaHtml = meta && typeof meta === "object"
    ? `<div class="field"><div class="k">meta (Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²)</div><div class="v mono">${esc(JSON.stringify(meta, null, 2))}</div></div>`
    : "";

  modalBody.innerHTML = `
    <div class="sectionTitle">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©</div>
    ${headerFields.concat(extraFields).filter(([_,v])=>v!==undefined && v!==null && String(v).trim()!=="").map(([k,v])=>`
      <div class="field"><div class="k">${esc(k)}</div><div class="v">${esc(v)}</div></div>
    `).join('')}

    <div class="sectionTitle">Ø£Ø¯ÙˆØ§Øª / Ø´ÙˆØ§Ù‡Ø¯</div>
    <div class="field"><div class="k">Ø£Ø¯ÙˆØ§Øª Ù‚ÙŠØ§Ø³ Ø§Ù„Ø£Ø«Ø±</div><div class="v">${toolsHtml}</div></div>
    <div class="field"><div class="k">Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯</div><div class="v">${evidenceHtml}</div></div>

    <div class="sectionTitle">Ø§Ù„Ø§Ø³ØªØ¨Ø§Ù†Ø© (Ø¹Ø±Ø¶ ÙƒØ§Ø³ØªÙ…Ø§Ø±Ø©)</div>
    ${formAnswersHtml}

    ${metaHtml}
  `;

  backdrop.style.display = "flex";
  backdrop.setAttribute("aria-hidden","false");
}

function closeModal(){
  backdrop.style.display = "none";
  backdrop.setAttribute("aria-hidden","true");
  modalBody.innerHTML = "";
}

closeX.addEventListener("click", closeModal);
backdrop.addEventListener("click", (e)=>{ if(e.target === backdrop) closeModal(); });
document.addEventListener("keydown", (e)=>{ if(e.key === "Escape" && backdrop.style.display === "flex") closeModal(); });

document.getElementById("loadBtn").addEventListener("click", loadFromSheet);
document.getElementById("exportCsvBtn").addEventListener("click", exportCsv);

/** Status */
(async ()=>{
  try{
    const ok = await ping();
    statusLine.textContent = ok ? "âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¬Ø§Ù‡Ø²" : "âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§ØªØµØ§Ù„";
  }catch{
    statusLine.textContent = "âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ â€” Ø±Ø§Ø¬Ø¹ÙŠ Ø§Ù„Ù†Ø´Ø± Web App (Anyone) ÙˆØ§Ù„Ø±Ø§Ø¨Ø·";
  }
})();
</script>
</body>
</html>
