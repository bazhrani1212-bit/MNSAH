<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة المديرة — نتائج قياس الأثر</title>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial; margin:0; background:#f6f7fb;}
    header{background:#334155; color:#fff; padding:14px 12px;}
    .wrap{max-width:1200px; margin:0 auto; padding:14px;}
    .card{background:#fff; border-radius:14px; padding:14px; box-shadow:0 1px 8px rgba(0,0,0,.06); margin:10px 0;}
    .btn{border:0; background:#0f766e; color:#fff; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:900}
    .btn.gray{background:#475569}
    input,select{padding:10px; border-radius:10px; border:1px solid #d0d7de; width:100%}
    .row{display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:10px}
    @media(max-width:1100px){.row{grid-template-columns:1fr 1fr}}
    @media(max-width:700px){.row{grid-template-columns:1fr}}
    table{width:100%; border-collapse:collapse; font-size:13px}
    th,td{border-bottom:1px solid #eef2f7; padding:10px; text-align:right; vertical-align:top}
    th{background:#f1f5f9}
    .hint{color:#64748b; font-size:12px}
    .ok,.err{display:none; padding:10px; border-radius:12px; margin:10px 0}
    .ok{background:#ecfdf5; border:1px solid #10b981; color:#065f46;}
    .err{background:#fef2f2; border:1px solid #ef4444; color:#7f1d1d;}
    .linklike{color:#0f766e; font-weight:900; cursor:pointer; text-decoration:underline}

    .stats{display:grid; grid-template-columns:repeat(4,1fr); gap:10px;}
    @media(max-width:1100px){.stats{grid-template-columns:repeat(2,1fr);}}
    @media(max-width:700px){.stats{grid-template-columns:1fr;}}
    .stat{border:1px solid #eef2f7; border-radius:14px; padding:12px;}
    .stat .k{color:#64748b; font-size:12px; margin-bottom:6px;}
    .stat .v{font-weight:1000; font-size:18px;}

    .backdrop{position:fixed; inset:0; background:rgba(15,23,42,.55); display:none; align-items:center; justify-content:center; padding:14px; z-index:9999;}
    .modal{max-width:900px; width:100%; background:#fff; border-radius:16px; overflow:hidden;}
    .modalHead{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; background:#f1f5f9; border-bottom:1px solid #e2e8f0;}
    .closeX{border:0; background:transparent; font-size:20px; cursor:pointer;}
    .modalBody{padding:14px; max-height:72vh; overflow:auto;}
    .qItem{border:1px solid #eef2f7; border-radius:12px; padding:10px; margin:8px 0;}
    footer{padding:18px 12px;color:#64748b;font-size:12px;text-align:center}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div style="font-weight:1000">لوحة المديرة — منصة قياس الأثر ورضا المستفيد</div>
    <div style="opacity:.95;font-size:13px;line-height:1.5;">
      المدرسة: <b>الابتدائية السادسة والثلاثون بالخميس</b> — مديرة المدرسة: <b>نورة الرفاعي</b>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="ok" id="okBox"></div>
  <div class="err" id="errBox"></div>

  <div class="card">
    <button class="btn gray" id="goHomeBtn">العودة للنماذج</button>
    <button class="btn" id="loadBtn">تحميل النتائج</button>
    <div class="hint" id="statusLine">جاهز</div>
  </div>

  <div class="card">
    <div class="row">
      <div><label class="hint">Admin Token</label><input id="tokenInput"></div>
      <div>
        <label class="hint">النوع</label>
        <select id="typeFilter">
          <option value="">الكل</option>
          <option value="impact">قياس الأثر</option>
          <option value="teacher_satisfaction">رضا المعلم</option>
          <option value="student_school_satisfaction">رضا الطالب عن المدرسة</option>
          <option value="parent_satisfaction">رضا ولي الأمر</option>
          <option value="student_teacher_satisfaction">رضا الطالب عن المعلم</option>
        </select>
      </div>
      <div><label class="hint">بحث</label><input id="searchText"></div>
      <div>
        <label class="hint">الحد</label>
        <select id="limitSel"><option>200</option><option selected>500</option><option>1000</option></select>
      </div>
    </div>
  </div>

  <div class="card">
    <div style="font-weight:1000;margin-bottom:10px;">إحصائيات</div>
    <div class="stats">
      <div class="stat"><div class="k">الإجمالي</div><div class="v" id="st_total">—</div></div>
      <div class="stat"><div class="k">قياس الأثر</div><div class="v" id="st_impact">—</div></div>
      <div class="stat"><div class="k">متوسط % الأثر</div><div class="v" id="st_avgImpactPct">—</div></div>
      <div class="stat"><div class="k">متوسط تحقق الأهداف</div><div class="v" id="st_avgGoalPct">—</div></div>
    </div>
  </div>

  <div class="card">
    <div class="hint" id="summaryLine">—</div>
    <div style="overflow:auto;margin-top:10px">
      <table>
        <thead><tr><th>النوع</th><th>التاريخ</th><th>المدرسة</th><th>عرض</th></tr></thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>
</div>

<footer>تصميم/إعداد: بدرية الزهراني</footer>

<div class="backdrop" id="backdrop">
  <div class="modal">
    <div class="modalHead">
      <div id="modalTitle" style="font-weight:1000">استجابة</div>
      <button class="closeX" id="closeX">✕</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
  </div>
</div>

<script>
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwy098HrSJ1vqA_xNQQal3lCD6Z1-S0vi2Q8_XNVPKNH8B_TQZZiskueR99RwjGjncC/exec";

const okBox = document.getElementById("okBox");
const errBox = document.getElementById("errBox");
function showOk(m){ okBox.textContent=m; okBox.style.display="block"; errBox.style.display="none"; setTimeout(()=>okBox.style.display="none",3500); }
function showErr(m){ errBox.textContent=m; errBox.style.display="block"; okBox.style.display="none"; setTimeout(()=>errBox.style.display="none",6500); }
function esc(s){ return (s??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function fmtType(t){
  return ({
    impact:"قياس الأثر",
    teacher_satisfaction:"رضا المعلم",
    student_school_satisfaction:"رضا الطالب عن المدرسة",
    parent_satisfaction:"رضا ولي الأمر",
    student_teacher_satisfaction:"رضا الطالب عن المعلم"
  })[t] || t;
}
function safeJson(v){ try{ return JSON.parse(v); }catch{ return null; } }

let allData = [];

function loadJSONP(url, cbName){
  return new Promise((resolve, reject)=>{
    const s = document.createElement("script");
    s.src = url;
    s.async = true;
    s.onerror = () => reject(new Error("JSONP_LOAD_FAILED"));
    window[cbName] = (data)=>{ resolve(data); cleanup(); };
    function cleanup(){
      try{ delete window[cbName]; }catch{}
      if(s.parentNode) s.parentNode.removeChild(s);
    }
    document.body.appendChild(s);
    setTimeout(()=>reject(new Error("JSONP_TIMEOUT")), 15000);
  });
}

async function loadFromSheet(){
  const token = document.getElementById("tokenInput").value.trim();
  if(!token){ showErr("ضعي Admin Token"); return; }

  const type = document.getElementById("typeFilter").value.trim();
  const q = document.getElementById("searchText").value.trim();
  const limit = document.getElementById("limitSel").value;

  const cbName = "cb_" + Math.random().toString(16).slice(2);
  const u = new URL(APPS_SCRIPT_URL);
  u.searchParams.set("action","list");
  u.searchParams.set("token", token);
  u.searchParams.set("limit", limit);
  if(type) u.searchParams.set("type", type);
  if(q) u.searchParams.set("q", q);
  u.searchParams.set("callback", cbName);

  try{
    const json = await loadJSONP(u.toString(), cbName);
    if(!json.ok){
      if(json.error==="UNAUTHORIZED"){ showErr("توكن غير صحيح"); return; }
      showErr(json.error||"فشل التحميل"); return;
    }
    allData = json.data || [];
    render();
    stats();
    showOk("تم التحميل ✅");
  }catch(e){
    console.error(e);
    showErr("تعذر تحميل النتائج (تأكدي من Deploy Anyone)");
  }
}

function render(){
  document.getElementById("summaryLine").textContent = "عدد النتائج: " + allData.length;
  const rows = document.getElementById("rows");
  rows.innerHTML = allData.map((x,i)=>`
    <tr>
      <td>${esc(fmtType(x.type))}</td>
      <td>${esc(x.createdAt||"")}</td>
      <td>${esc(x.school||"")}</td>
      <td><span class="linklike" data-i="${i}">عرض</span></td>
    </tr>
  `).join("");
  rows.querySelectorAll("[data-i]").forEach(el=>{
    el.addEventListener("click", ()=>openModal(allData[Number(el.dataset.i)]));
  });
}

function stats(){
  document.getElementById("st_total").textContent = allData.length;
  const impacts = allData.filter(x=>x.type==="impact");
  document.getElementById("st_impact").textContent = impacts.length;

  const avg = (arr, key)=>{
    const nums = arr.map(x=>Number(x[key])).filter(n=>!Number.isNaN(n) && n>0);
    if(!nums.length) return "—";
    return Math.round(nums.reduce((a,b)=>a+b,0)/nums.length) + "%";
  };
  document.getElementById("st_avgImpactPct").textContent = avg(impacts,"effectPct");
  document.getElementById("st_avgGoalPct").textContent = avg(impacts,"goalPct");
}

/** Modal */
const backdrop = document.getElementById("backdrop");
const modalBody = document.getElementById("modalBody");
const modalTitle = document.getElementById("modalTitle");
document.getElementById("closeX").addEventListener("click", closeModal);
backdrop.addEventListener("click", (e)=>{ if(e.target===backdrop) closeModal(); });
document.addEventListener("keydown",(e)=>{ if(e.key==="Escape" && backdrop.style.display==="flex") closeModal(); });

function openModal(x){
  modalTitle.textContent = `استجابة — ${fmtType(x.type)} — ${x.createdAt||""}`;
  const answers = typeof x.answers==="string" ? safeJson(x.answers) : x.answers;

  let formHtml = "";
  if(answers && typeof answers==="object"){
    formHtml = Object.entries(answers).map(([k,v])=>`
      <div class="qItem"><div><b>البند ${esc(k)}</b></div><div>الإجابة: ${esc(v||"—")}</div></div>
    `).join("");
  } else {
    formHtml = `<div class="hint">لا توجد إجابات بنود</div>`;
  }

  modalBody.innerHTML = `
    <div class="qItem"><b>المدرسة:</b> ${esc(x.school||"")}</div>
    <div class="qItem"><b>النوع:</b> ${esc(fmtType(x.type))}</div>
    ${x.type==="impact" ? `
      <div class="qItem"><b>البرنامج:</b> ${esc(x.program||"")}</div>
      <div class="qItem"><b>% الأثر:</b> ${esc(x.effectPct||"")}</div>
      <div class="qItem"><b>% تحقق الأهداف:</b> ${esc(x.goalPct||"")}</div>
      <div class="qItem"><b>إيجابيات:</b><br>${esc(x.positives||"")}</div>
      <div class="qItem"><b>صعوبات:</b><br>${esc(x.challenges||"")}</div>
    ` : `
      <div style="margin-top:10px;font-weight:1000;">الاستبانة</div>
      ${formHtml}
    `}
  `;
  backdrop.style.display="flex";
}
function closeModal(){ backdrop.style.display="none"; modalBody.innerHTML=""; }

/** Buttons */
document.getElementById("loadBtn").addEventListener("click", loadFromSheet);
document.getElementById("goHomeBtn").addEventListener("click", ()=>{
  const base = location.origin + location.pathname.split("/").slice(0,-1).join("/") + "/";
  window.location.href = base;
});
</script>
</body>
</html>
