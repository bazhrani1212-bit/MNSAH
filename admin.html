<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة المديرة — نتائج قياس الأثر</title>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial; margin:0; background:#f6f7fb;}
    header{background:#334155; color:#fff; padding:14px 12px;}
    .wrap{max-width:1200px; margin:0 auto; padding:14px;}
    .brand{display:flex; flex-direction:column; gap:6px;}
    .brand h1{margin:0; font-size:18px; font-weight:900;}
    .brand .sub{opacity:.95; font-size:13px; line-height:1.5;}
    .card{background:#fff; border-radius:14px; padding:14px; box-shadow:0 1px 8px rgba(0,0,0,.06); margin:10px 0;}
    .btn{border:0; background:#0f766e; color:#fff; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:900}
    .btn.gray{background:#475569}
    input,select{padding:10px; border-radius:10px; border:1px solid #d0d7de; width:100%}
    .row{display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:10px}
    @media(max-width:1100px){.row{grid-template-columns:1fr 1fr}}
    @media(max-width:700px){.row{grid-template-columns:1fr}}
    table{width:100%; border-collapse:collapse; font-size:13px}
    th,td{border-bottom:1px solid #eef2f7; padding:10px; text-align:right; vertical-align:top}
    th{background:#f1f5f9}
    .hint{color:#64748b; font-size:12px}
    .ok{background:#ecfdf5; border:1px solid #10b981; color:#065f46; padding:10px; border-radius:12px; display:none}
    .err{background:#fef2f2; border:1px solid #ef4444; color:#7f1d1d; padding:10px; border-radius:12px; display:none}
    footer{padding:18px 12px; color:#64748b; font-size:12px; text-align:center}
    .actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .tag{display:inline-block; padding:4px 10px; border-radius:999px; background:#e2e8f0; font-size:12px; margin:2px 4px 2px 0;}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <h1>لوحة المديرة — منصة قياس الأثر ورضا المستفيد</h1>
      <div class="sub">
        المدرسة: <b>الابتدائية السادسة والثلاثون بالخميس</b> — مديرة المدرسة: <b>نورة الرفاعي</b><br>
        عرض مباشر من Google Sheet (يتطلب Admin Token).
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="ok" id="okBox"></div>
  <div class="err" id="errBox"></div>

  <div class="card">
    <div class="actions">
      <a class="btn gray" href="index.html">العودة للنماذج</a>
      <button class="btn" id="loadBtn">تحميل النتائج</button>
      <button class="btn gray" id="exportCsvBtn">تصدير CSV</button>
    </div>
    <div class="hint" style="margin-top:10px" id="statusLine">⏳ فحص الاتصال…</div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <label class="hint">Admin Token</label>
        <input id="tokenInput" placeholder="التوكن الموجود في ورقة settings داخل Google Sheet" />
      </div>
      <div>
        <label class="hint">النوع</label>
        <select id="typeFilter">
          <option value="">الكل</option>
          <option value="impact">قياس الأثر</option>
          <option value="teacher_satisfaction">رضا المعلم</option>
          <option value="student_school_satisfaction">رضا الطالب عن المدرسة</option>
          <option value="parent_satisfaction">رضا ولي الأمر</option>
          <option value="student_teacher_satisfaction">رضا الطالب عن المعلم</option>
        </select>
      </div>
      <div>
        <label class="hint">بحث نصي</label>
        <input id="searchText" placeholder="علوم / برنامج / أثر ..." />
      </div>
      <div>
        <label class="hint">الحد</label>
        <select id="limitSel">
          <option value="200">200</option>
          <option value="500" selected>500</option>
          <option value="1000">1000</option>
          <option value="2000">2000</option>
        </select>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="hint" id="summaryLine">—</div>
    <div style="overflow:auto; margin-top:10px">
      <table>
        <thead>
          <tr>
            <th>النوع</th>
            <th>التاريخ</th>
            <th>المدرسة</th>
            <th>مختصر</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>
</div>

<footer>تصميم/إعداد: بدرية الزهراني</footer>

<script>
/** رابط Web App (مُثبت منك) */
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyZBgj7Qomh3858lXJWripmkFlKW_bcUD8POm7XXCuk6nAQJAc6EPZdFu8YOciaMdUM/exec";

/** UI */
const okBox = document.getElementById('okBox');
const errBox = document.getElementById('errBox');
const statusLine = document.getElementById('statusLine');

function showOk(msg){ okBox.textContent=msg; okBox.style.display='block'; errBox.style.display='none'; setTimeout(()=>okBox.style.display='none', 3500); }
function showErr(msg){ errBox.textContent=msg; errBox.style.display='block'; okBox.style.display='none'; setTimeout(()=>errBox.style.display='none', 6500); }

const rowsEl = document.getElementById("rows");
const summaryLine = document.getElementById("summaryLine");
const tokenInput = document.getElementById("tokenInput");
const typeFilter = document.getElementById("typeFilter");
const searchText = document.getElementById("searchText");
const limitSel = document.getElementById("limitSel");

let allData = [];

function esc(s){ return (s??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function fmtType(t){
  const map={impact:"قياس الأثر",teacher_satisfaction:"رضا المعلم",student_school_satisfaction:"رضا الطالب عن المدرسة",parent_satisfaction:"رضا ولي الأمر",student_teacher_satisfaction:"رضا الطالب عن المعلم"};
  return map[t]||t;
}
function rowBrief(x){
  if(x.type==="impact"){
    const tags=[x.program?`برنامج: ${x.program}`:null,x.impactLevel?`الأثر: ${x.impactLevel}`:null,(x.effectPct!=="" && x.effectPct!=null)?`%الأثر: ${x.effectPct}`:null].filter(Boolean);
    return tags.map(t=>`<span class="tag">${esc(t)}</span>`).join('');
  }
  let answered = 0;
  try{
    const ans = (typeof x.answers === "string") ? JSON.parse(x.answers) : x.answers;
    answered = ans ? Object.values(ans).filter(Boolean).length : 0;
  }catch{}
  const tags=[`بنود مجابة: ${answered}`, x.subject?`مادة: ${x.subject}`:null].filter(Boolean);
  return tags.map(t=>`<span class="tag">${esc(t)}</span>`).join('');
}

async function ping(){
  const r = await fetch(`${APPS_SCRIPT_URL}?action=ping`);
  const j = await r.json();
  return !!j?.ok;
}

async function loadFromSheet(){
  const token = tokenInput.value.trim();
  if(!token){ showErr("ضعي Admin Token أولًا."); return; }

  const type = typeFilter.value.trim();
  const q = searchText.value.trim();
  const limit = Number(limitSel.value||500);

  const u = new URL(APPS_SCRIPT_URL);
  u.searchParams.set("action","list");
  u.searchParams.set("token", token);
  u.searchParams.set("limit", String(limit));
  if(type) u.searchParams.set("type", type);
  if(q) u.searchParams.set("q", q);

  try{
    const res = await fetch(u.toString());
    const json = await res.json();
    if(!json.ok){
      if(json.error === "UNAUTHORIZED") { showErr("توكن غير صحيح (settings → ADMIN_TOKEN)."); return; }
      throw new Error(json.error || "LOAD_FAILED");
    }
    allData = json.data || [];
    render();
    showOk("تم تحميل النتائج ✅");
  }catch(e){
    console.error(e);
    showErr("تعذر تحميل النتائج. تحققي من: نشر Web App (Anyone) + الصلاحيات + وجود sheets: responses/settings");
  }
}

function render(){
  summaryLine.textContent = `عدد النتائج المعروضة: ${allData.length}`;
  rowsEl.innerHTML = allData.map(x=>`
    <tr>
      <td>${esc(fmtType(x.type))}</td>
      <td>${esc(x.createdAt||"")}</td>
      <td>${esc(x.school||"—")}</td>
      <td>${rowBrief(x)}</td>
    </tr>
  `).join('');
}

function exportCsv(){
  if(!allData.length){ showErr("لا توجد نتائج لتصديرها."); return; }
  const cols = Object.keys(allData[0]);
  const lines = [cols.join(",")];
  allData.forEach(x=>{
    const row = cols.map(c => `"${String(x[c]??"").replaceAll('"','""')}"`);
    lines.push(row.join(","));
  });
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "admin_view.csv"; a.click();
  URL.revokeObjectURL(url);
}

document.getElementById("loadBtn").addEventListener("click", loadFromSheet);
document.getElementById("exportCsvBtn").addEventListener("click", exportCsv);

/** Status */
(async ()=>{
  try{
    const ok = await ping();
    statusLine.textContent = ok ? "✅ الاتصال جاهز" : "⚠️ لم يتم تأكيد الاتصال";
  }catch{
    statusLine.textContent = "❌ تعذر الاتصال — راجعي النشر Web App (Anyone) والصلاحيات";
  }
})();
</script>
</body>
</html>
